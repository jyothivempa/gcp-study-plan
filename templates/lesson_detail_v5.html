{% extends 'base.html' %}
{% load static %}
{% load markdown_extras %}
{% load quiz_extras %}

{% block title %}Day {{ day.number }}: {{ day.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reader.css' %}">
{% endblock %}

{% block content %}
<div class="flex h-full bg-white dark:bg-dark-bg transition-colors" x-data="{ 
    sidebarOpen: false, 
    sidebarData: { week_number: '...', items: [] },
    loading: true,
    async loadSidebar() {
        try {
            const res = await fetch('/curriculum/api/sidebar_data/{{ course.slug }}/{{ day.number }}/');
            this.sidebarData = await res.json();
            this.loading = false;
        } catch(e) { console.error('Failed to load sidebar', e); }
    }
}" x-init="loadSidebar()">

    <!-- 1. LEFT SIDEBAR (Collapsed on mobile, Standard on Desktop) -->
    <!-- Reusing the V4 Sidebar Logic but minimized/collapsible -->
    <aside
        class="hidden xl:flex flex-col w-72 h-[calc(100vh-4rem)] sticky top-0 border-r border-slate-200 dark:border-white/5 bg-slate-50/50 dark:bg-dark-card/30 backdrop-blur-sm z-20">
        <div class="p-6 border-b border-slate-200 dark:border-white/5">
            <span class="text-[10px] uppercase tracking-widest font-bold text-brand-600 dark:text-brand-400">Module
                <span x-text="sidebarData.week_number"></span></span>
            <h3 class="font-display font-bold text-slate-900 dark:text-white">Week <span
                    x-text="sidebarData.week_number"></span> Curriculum</h3>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar">
            <template x-if="loading">
                <div class="space-y-2 animate-pulse">
                    <div class="h-10 bg-slate-200 dark:bg-slate-800 rounded-lg"></div>
                    <div class="h-10 bg-slate-200 dark:bg-slate-800 rounded-lg"></div>
                </div>
            </template>
            <template x-for="item in sidebarData.items" :key="item.number">
                <a :href="item.url" :class="item.row_class + ' !p-2 !gap-2'">
                    <div :class="item.icon_class + ' !w-6 !h-6 !text-[10px]'">
                        <template x-if="item.is_past"><i class="fa-solid fa-check"></i></template>
                        <template x-if="!item.is_past"><span x-text="item.number"></span></template>
                    </div>
                    <span :class="item.text_class + ' !text-xs'" x-text="item.title"></span>
                </a>
            </template>
        </div>
    </aside>

    <!-- 2. MAIN READER CONTENT -->
    <main class="flex-1 h-full overflow-y-auto relative scroll-smooth" id="main-scroll">

        <!-- PROGRESS BAR -->
        <div class="fixed top-16 left-0 w-full h-1 bg-slate-200 dark:bg-white/5 z-50">
            <div class="h-full bg-brand-500 transition-all duration-100" id="reading-progress" style="width: 0%"></div>
        </div>

        <div class="max-w-7xl mx-auto px-4 lg:px-8 py-12 reader-layout">

            <!-- CONTENT COLUMN -->
            <article class="reader-container">

                <!-- BREADCRUMBS -->
                <nav class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-8 font-medium">
                    <a href="{% url 'curriculum_overview' %}"
                        class="hover:text-brand-600 dark:hover:text-brand-400 transition">Curriculum</a>
                    <i class="fa-solid fa-chevron-right text-[10px]"></i>
                    <span class="text-slate-900 dark:text-slate-200">Day {{ day.number }}</span>
                </nav>

                <!-- HERO SECTION -->
                <header class="mb-12">
                    <div class="inline-flex items-center gap-3 mb-6">
                        <span
                            class="px-3 py-1 rounded-full bg-brand-100 dark:bg-brand-900/40 text-brand-700 dark:text-brand-300 text-xs font-bold uppercase tracking-widest border border-brand-200 dark:border-brand-500/20">
                            Day {{ day.number }}
                        </span>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">{{ week_title }}</span>
                    </div>

                    <h1
                        class="text-4xl lg:text-5xl font-display font-black leading-tight mb-6 text-slate-900 dark:text-white">
                        {{ day.title }}
                    </h1>

                    <div
                        class="flex items-center gap-6 text-sm text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-white/10 pb-8 mb-8">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
                                <!-- Author Avatar (Placeholder) -->
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=GCP" alt="Author" />
                            </div>
                            <span>GCP Mastery Team</span>
                        </div>
                        <span>&bull;</span>
                        <span>12 min read</span>
                        <span>&bull;</span>
                        <span class="text-brand-600 dark:text-brand-400 font-bold">Concept Deep Dive</span>
                    </div>

                    <!-- Learning Objective Card -->
                    <div
                        class="bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-white/5 rounded-2xl p-6 mb-8 flex gap-4">
                        <div
                            class="shrink-0 w-12 h-12 bg-brand-100 dark:bg-brand-900/30 rounded-xl flex items-center justify-center text-brand-600 dark:text-brand-400 text-xl">
                            <i class="fa-solid fa-bullseye"></i>
                        </div>
                        <div>
                            <h3
                                class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-1">
                                Learning Objective</h3>
                            <p class="font-medium text-slate-800 dark:text-slate-200 italic">"{{ day.outcome }}"</p>
                        </div>
                    </div>
                </header>

                <!-- MARKDOWN CONTENT (With Reader Typography) -->
                <div class="prose prose-reader max-w-none" id="content-body">
                    {{ day.concept_content|markdown|safe }}
                </div>

                <!-- NAVIGATION FOOTER -->
                <div class="mt-16 pt-12 border-t border-slate-200 dark:border-white/10 flex justify-between">
                    {% if prev_day %}
                    <a href="{% url 'lesson_detail' course.slug prev_day.number %}"
                        class="group flex flex-col items-start gap-1">
                        <span
                            class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-brand-500 transition">Previous</span>
                        <span
                            class="text-lg font-bold text-slate-700 dark:text-slate-300 group-hover:text-brand-600 dark:group-hover:text-brand-400 transition flex items-center gap-2">
                            <i class="fa-solid fa-arrow-left"></i> Day {{ prev_day.number }}
                        </span>
                    </a>
                    {% else %}<div></div>{% endif %}

                    {% if next_day %}
                    <a href="{% url 'lesson_detail' course.slug next_day.number %}"
                        class="group flex flex-col items-end gap-1">
                        <span
                            class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-brand-500 transition">Next</span>
                        <span
                            class="text-lg font-bold text-slate-700 dark:text-slate-300 group-hover:text-brand-600 dark:group-hover:text-brand-400 transition flex items-center gap-2">
                            Day {{ next_day.number }} <i class="fa-solid fa-arrow-right"></i>
                        </span>
                    </a>
                    {% endif %}
                </div>

                <!-- ðŸš€ PART 2: HANDS-ON LABS (Restored) -->
                {% if day.hands_on_content %}
                <section class="mt-24 pt-12 border-t-2 border-slate-200 dark:border-white/5" id="labs">
                    <div class="flex items-center gap-4 mb-8">
                        <div
                            class="w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 text-2xl">
                            <i class="fa-solid fa-flask"></i>
                        </div>
                        <h2 class="text-3xl font-display font-bold text-slate-900 dark:text-white !m-0 !border-0">
                            Hands-on Lab</h2>
                    </div>

                    <div class="prose prose-reader max-w-none">
                        {{ day.hands_on_content|markdown|safe }}
                    </div>
                </section>
                {% endif %}

                <!-- ðŸ§  PART 3: QUIZ (Restored) -->
                {% if day.quiz_questions.all %}
                <section class="mt-24 pt-12 border-t-2 border-slate-200 dark:border-white/5" id="quiz" x-data="{
                    activeQuestion: 0,
                    score: 0,
                    showResults: false,
                    questions: [
                        {% for q in day.quiz_questions.all %}
                        {
                            id: {{ q.id }},
                            text: `{{ q.question_text|escapejs }}`,
                            options: {
                                'A': `{{ q.option_1|escapejs }}`,
                                'B': `{{ q.option_2|escapejs }}`,
                                'C': `{{ q.option_3|escapejs }}`,
                                'D': `{{ q.option_4|escapejs }}`
                            },
                            correct: '{{ q.correct_option }}',
                            explanation: `{{ q.explanation|escapejs }}`,
                            selected: null
                        },
                        {% endfor %}
                    ],
                    selectOption(idx, optionKey) {
                        if (this.questions[idx].selected) return; // Already answered
                        this.questions[idx].selected = optionKey;
                        if (optionKey === this.questions[idx].correct) this.score++;
                    }
                }">
                    <div class="flex items-center gap-4 mb-8">
                        <div
                            class="w-12 h-12 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400 text-2xl">
                            <i class="fa-solid fa-brain"></i>
                        </div>
                        <h2 class="text-3xl font-display font-bold text-slate-900 dark:text-white !m-0 !border-0">
                            Knowledge Check</h2>
                    </div>

                    <!-- Quiz UI -->
                    <div class="space-y-8">
                        <template x-for="(q, idx) in questions" :key="q.id">
                            <div class="p-6 rounded-2xl bg-slate-50 dark:bg-white/5 border border-slate-200 dark:border-white/10 transition-all"
                                :class="q.selected ? (q.selected === q.correct ? 'border-green-500/50 bg-green-500/5' : 'border-red-500/50 bg-red-500/5') : ''">

                                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">
                                    <span class="text-slate-400 mr-2">#<span x-text="idx + 1"></span></span>
                                    <span x-text="q.text"></span>
                                </h3>

                                <div class="space-y-3">
                                    <template x-for="(optText, optKey) in q.options" :key="optKey">
                                        <button @click="selectOption(idx, optKey)"
                                            class="w-full text-left p-4 rounded-xl border-2 transition-all flex items-center justify-between group"
                                            :class="{
                                                'border-slate-200 dark:border-white/10 hover:border-brand-300 dark:hover:border-brand-500/50 hover:bg-white dark:hover:bg-white/5': !q.selected,
                                                'border-green-500 bg-green-500/10 text-green-700 dark:text-green-300': q.selected && optKey === q.correct,
                                                'border-red-500 bg-red-500/10 text-red-700 dark:text-red-300': q.selected && q.selected === optKey && optKey !== q.correct,
                                                'opacity-50': q.selected && optKey !== q.correct && optKey !== q.selected
                                            }">
                                            <span class="font-medium">
                                                <span class="font-bold uppercase mr-2" x-text="optKey"></span>
                                                <span x-text="optText"></span>
                                            </span>

                                            <!-- Icons -->
                                            <template x-if="q.selected && optKey === q.correct">
                                                <i class="fa-solid fa-check-circle text-green-500 text-xl"></i>
                                            </template>
                                            <template
                                                x-if="q.selected && q.selected === optKey && optKey !== q.correct">
                                                <i class="fa-solid fa-circle-xmark text-red-500 text-xl"></i>
                                            </template>
                                        </button>
                                    </template>
                                </div>

                                <!-- Explanation -->
                                <div x-show="q.selected" x-collapse
                                    class="mt-4 p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 text-sm">
                                    <strong class="block mb-1"><i class="fa-solid fa-lightbulb mr-1"></i>
                                        Explanation</strong>
                                    <span x-text="q.explanation"></span>
                                </div>
                            </div>
                        </template>

                        <!-- Score Summary -->
                        <div class="p-8 rounded-2xl bg-slate-900 dark:bg-black text-white text-center"
                            x-show="questions.every(q => q.selected)">
                            <h3 class="text-2xl font-bold mb-2">Quiz Complete!</h3>
                            <p class="text-xl">You scored <span x-text="score"></span> / <span
                                    x-text="questions.length"></span></p>
                            <div class="w-full bg-white/20 h-2 rounded-full mt-4 overflow-hidden">
                                <div class="bg-brand-500 h-full transition-all duration-1000"
                                    :style="`width: ${(score/questions.length)*100}%`"></div>
                            </div>
                        </div>
                    </div>
                </section>
                {% endif %}

            </article>

            <!-- RIGHT SIDEBAR: TOC -->
            <aside class="hidden lg:block relative">
                <div class="sticky-toc w-full pl-6 border-l border-slate-200 dark:border-white/5">
                    <h4 class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-4">On this page</h4>
                    <nav id="toc-nav" class="space-y-1">
                        <!-- JS will populate this -->
                    </nav>
                </div>
            </aside>

        </div>
    </main>
</div>

<!-- SCRIPTS -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const contentBody = document.getElementById('content-body');
        const tocNav = document.getElementById('toc-nav');
        const mainScroll = document.getElementById('main-scroll');
        const progressBar = document.getElementById('reading-progress');

        // 1. GENERATE TOC & ANCHORS
        const headers = contentBody.querySelectorAll('h2, h3');
        headers.forEach((header, index) => {
            // Create ID if missing (Markdown extension should assume it, but fallback)
            if (!header.id) {
                header.id = 'section-' + index;
            }

            // Create TOC Link
            const link = document.createElement('a');
            link.href = '#' + header.id;
            link.textContent = header.textContent;
            link.className = 'toc-link';
            if (header.tagName === 'H3') {
                link.style.paddingLeft = '1.5rem';
                link.style.fontSize = '0.8rem';
            }
            tocNav.appendChild(link);

            // Click Handler for smooth scroll
            link.addEventListener('click', (e) => {
                e.preventDefault();
                header.scrollIntoView({ behavior: 'smooth' });
                // Update URL hash without jump
                history.pushState(null, null, '#' + header.id);
            });
        });

        // 2. ACTIVE TOC HIGHLIGHT & PROGRESS BAR
        mainScroll.addEventListener('scroll', () => {
            // Progress Bar
            const scrollTop = mainScroll.scrollTop;
            const scrollHeight = mainScroll.scrollHeight - mainScroll.clientHeight;
            const progress = (scrollTop / scrollHeight) * 100;
            progressBar.style.width = progress + '%';

            // Active TOC
            let current = '';
            headers.forEach(header => {
                const sectionTop = header.offsetTop;
                if (scrollTop >= (sectionTop - 150)) {
                    current = header.getAttribute('id');
                }
            });

            document.querySelectorAll('.toc-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });

        // 3. ENHANCE BLOCKQUOTES -> CALLOUTS
        // Pattern: > [!NOTE] Title ...
        // Logic: Find blockquotes, check first child text
        contentBody.querySelectorAll('blockquote').forEach(bq => {
            const p = bq.querySelector('p');
            if (p) {
                const text = p.innerHTML;
                const match = text.match(/^\s*\[!(NOTE|TIP|WARNING|IMPORTANT|CAUTION)\]/i);

                if (match) {
                    const type = match[1].toLowerCase();
                    const cleanText = text.replace(match[0], '').trim();

                    // Transform to Div
                    const div = document.createElement('div');
                    div.className = `callout callout-${type}`;

                    // Icon logic
                    let icon = 'circle-info';
                    if (type === 'tip') icon = 'lightbulb';
                    if (type === 'warning') icon = 'triangle-exclamation';
                    if (type === 'important') icon = 'circle-exclamation';
                    if (type === 'caution') icon = 'radiation'; // or skull

                    div.innerHTML = `
                        <div class="text-xl shrink-0"><i class="fa-solid fa-${icon}"></i></div>
                        <div class="flex-1">${cleanText}</div>
                    `;

                    bq.replaceWith(div);
                }
            }
        });

        // 4. CODE COPY BUTTONS
        contentBody.querySelectorAll('pre').forEach(pre => {
            const btn = document.createElement('button');
            btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
            btn.className = 'absolute top-2 right-2 p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition opacity-0 group-hover:opacity-100';
            // Add group class to pre
            pre.classList.add('group');
            pre.appendChild(btn);

            btn.addEventListener('click', () => {
                const code = pre.querySelector('code').textContent;
                navigator.clipboard.writeText(code);
                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i>', 2000);
            });
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}