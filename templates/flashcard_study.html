{% extends 'base.html' %}
{% load static %}

{% block title %}Study Mode - Day {{ day.number }}{% endblock %}

{% block content %}
<div class="flex-1 bg-slate-50 flex items-center justify-center p-4" x-data="studySession()">

    <!-- MAIN CARD CONTAINER -->
    <div class="max-w-xl w-full relative perspective-1000">

        <!-- Progress Header -->
        <div class="absolute -top-16 left-0 right-0 flex items-center justify-between text-slate-500 font-bold text-sm">
            <div><i class="fa-solid fa-layer-group text-brand-500 mr-2"></i> Card <span
                    x-text="currentIndex + 1"></span>/<span x-text="cards.length"></span></div>
            <a href="{% url 'lesson_detail' day.week.course.slug day.number %}"
                class="hover:text-brand-600 transition"><i class="fa-solid fa-times text-lg"></i></a>
        </div>

        <!-- The Flashcard -->
        <div class="relative h-[400px] w-full transform-style-3d transition-transform duration-500 cursor-pointer"
            :class="{'rotate-y-180': isFlipped}" @click="isFlipped = !isFlipped">

            <!-- FRONT -->
            <div
                class="absolute inset-0 backface-hidden bg-white rounded-3xl shadow-2xl shadow-slate-200 border border-white flex flex-col items-center justify-center p-8 text-center">
                <div
                    class="w-16 h-16 rounded-2xl bg-brand-50 text-brand-600 flex items-center justify-center text-3xl mb-6 shadow-sm">
                    <i class="fa-solid fa-question"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800" x-text="currentCard.front"></h3>
                <p class="text-slate-400 mt-4 text-xs font-bold uppercase tracking-widest">Tap to Flip</p>
            </div>

            <!-- BACK -->
            <div
                class="absolute inset-0 backface-hidden rotate-y-180 bg-slate-900 rounded-3xl shadow-2xl flex flex-col items-center justify-center p-8 text-center text-white">
                <div
                    class="w-16 h-16 rounded-2xl bg-white/10 text-brand-300 flex items-center justify-center text-3xl mb-6 shadow-none">
                    <i class="fa-solid fa-lightbulb"></i>
                </div>
                <p class="text-xl font-medium leading-relaxed" x-text="currentCard.back"></p>

                <!-- AI Explanation Section -->
                <div class="mt-6">
                    <template x-if="!explanation && !explaining">
                        <button @click.stop="explain()"
                            class="text-xs font-bold text-indigo-300 border border-indigo-300/30 rounded-full px-3 py-1.5 hover:bg-indigo-300/10 transition-colors flex items-center mx-auto gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Explain with AI
                        </button>
                    </template>

                    <template x-if="explaining">
                        <div class="flex items-center justify-center gap-2 text-indigo-300 text-xs animate-pulse">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...
                        </div>
                    </template>

                    <div x-show="explanation" x-transition
                        class="text-left bg-indigo-900/50 rounded-xl p-4 text-xs text-indigo-100 border border-indigo-500/30 shadow-inner">
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-robot text-indigo-400 mt-0.5"></i>
                            <p x-text="explanation" class="leading-relaxed"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="mt-8 flex items-center justify-center gap-6" x-show="isFlipped" x-transition.opacity>
            <button @click.stop="submitResult('hard')"
                class="w-16 h-16 rounded-full bg-red-100 text-red-600 text-2xl hover:bg-red-200 hover:scale-110 transition-all shadow-lg flex items-center justify-center"
                title="Hard (Reset Box)">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div class="text-center">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest block mb-1">How was it?</span>
                <div class="h-1 w-20 bg-slate-200 rounded-full mx-auto"></div>
            </div>
            <button @click.stop="submitResult('easy')"
                class="w-16 h-16 rounded-full bg-green-100 text-green-600 text-2xl hover:bg-green-200 hover:scale-110 transition-all shadow-lg flex items-center justify-center"
                title="Easy (Promote Box)">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>

    </div>

    <!-- COMPLETION MODAL -->
    <div x-show="finished" class="fixed inset-0 z-50 flex items-center justify-center bg-white/90 backdrop-blur-md p-4"
        style="display: none;">
        <div class="text-center max-w-md">
            <div
                class="w-24 h-24 bg-brand-100 text-brand-600 rounded-full mx-auto flex items-center justify-center text-5xl mb-6 shadow-xl animate-bounce">
                <i class="fa-solid fa-crown"></i>
            </div>
            <h2 class="text-3xl font-black text-slate-900 mb-2">Session Complete!</h2>
            <p class="text-slate-500 mb-8 text-lg">You've reviewed all cards for today.</p>
            <a href="{% url 'lesson_detail' day.week.course.slug day.number %}"
                class="inline-flex items-center justify-center px-8 py-4 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 hover:shadow-lg hover:-translate-y-1 transition-all">
                Return to Lesson
            </a>
        </div>
    </div>

</div>

<script src="{% static 'js/flashcard_logic.js' %}"></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('studySession', () => studySession({
            cards: {{ cards_json | safe }},
        dayNumber: {{ day.number }},
        csrfToken: '{{ csrf_token }}',
        urls: {
        explain: '{% url "explain_flashcard" %}',
        submit: '{% url "submit_flashcard" %}'
    }
        }));
    });
</script>
{% endblock %}